<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Ship Equipment Status</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f9f9f9; margin:0; }
    h2 { color: #2e7d32; margin: 0; }

    /* ìƒë‹¨ ê³ ì •ë°”: ë¡œê³ ê°€ ë³¸ë¬¸ ê°€ë¦¬ì§€ ì•Šê²Œ */
    .topbar {
      position: fixed; top: 0; left: 0; right: 0;
      height: 64px; background:#ffffff; border-bottom:1px solid #e0e0e0;
      display:flex; align-items:center; justify-content:space-between;
      padding: 0 16px; z-index: 1000;
    }
    .leftbar { display:flex; align-items:center; gap:12px; }
    .rightbar { display:flex; align-items:center; gap:8px; }
    .logo { height:48px; display:block; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#e8f5e9; color:#1b5e20; font-size:12px; text-decoration:none; }

    .page { padding: 20px; padding-top: 88px; }

    select { padding: 6px; margin: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #2e7d32; color: white; }
    .done { background-color: #e8f5e9; }
    .muted { color:#666; font-size:12px; }
    .panel { background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:12px; margin-top:12px; }
    .btn { padding:6px 10px; border:none; border-radius:4px; cursor:pointer; }
    .btn.primary { background:#2e7d32; color:#fff; }
    .btn.ghost { background:#fff; border:1px solid #2e7d32; color:#2e7d32; }
    .nowrap { white-space:nowrap; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input[type="text"], input[type="tel"], input[type="email"], input[type="number"] { padding:6px; border:1px solid #ccc; border-radius:4px; }

    .inline-form { display:grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap:10px; align-items:end; }
    .field { display:flex; flex-direction:column; gap:4px; }
    .field label { font-size:12px; color:#444; }
    .list-compact td { text-align:left; }
  </style>
</head>
<body>

  <!-- ìƒë‹¨ ê³ ì •ë°” -->
  <div class="topbar">
    <div class="leftbar">
      <a href="{{ url_for('home') }}" title="Hyundai Mipo Dockyard">
        <img class="logo" src="{{ url_for('static', filename='hmipo_logo.png') }}" alt="Hyundai Mipo Logo">
      </a>
      <h2>ğŸš¢ Ship Equipment Status</h2>
    </div>
    <div class="rightbar">
      {% if session.get('user') %}
        <span class="pill">{{ session['user']['email'] }}</span>
        <a class="pill" href="{{ url_for('admin_dashboard') }}">Admin</a>
        <a class="pill" href="{{ url_for('logout') }}">ë¡œê·¸ì•„ì›ƒ</a>
      {% else %}
        <a class="pill" href="{{ url_for('login') }}">ë¡œê·¸ì¸</a>
      {% endif %}
    </div>
  </div>

  <div class="page">
    <!-- ìƒë‹¨ ì„ íƒ -->
    <form method="get" action="/">
      <label><b>Ship Number:</b></label>
      <select name="ship_number" id="ship_number" onchange="this.form.submit()">
        <option value="">-- Select --</option>
        <option value="1" {% if selected_ship == "1" %}selected{% endif %}>Ship 1</option>
        <option value="2" {% if selected_ship == "2" %}selected{% endif %}>Ship 2</option>
        <option value="3" {% if selected_ship == "3" %}selected{% endif %}>Ship 3</option>
      </select>

      {% if categories %}
        <label><b>System:</b></label>
        <select name="category" id="category" onchange="this.form.submit()">
          <option value="">-- Select --</option>
          {% for c in categories %}
            <option value="{{ c }}" {% if selected_category == c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      {% endif %}
    </form>

    {% if selected_ship %}
      <p class="muted" style="margin-top:10px;">â° Due Date for Ship {{ selected_ship }}: {{ due_date }}</p>
    {% endif %}

    {% if selected_ship and selected_category %}
    <!-- ì‹œìŠ¤í…œ ìƒíƒœ & ë‹´ë‹¹ì -->
    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <b>ì‹œìŠ¤í…œ ìƒíƒœ:</b>
          <form method="post" action="{{ url_for('category_status_set') }}" class="row">
            <input type="hidden" name="ship_number" value="{{ selected_ship }}">
            <input type="hidden" name="category" value="{{ selected_category }}">
            <button class="btn {% if cat_status=='ë¯¸ì…ë ¥' %}primary{% else %}ghost{% endif %}" name="status" value="ë¯¸ì…ë ¥" type="submit">ë¯¸ì…ë ¥</button>
            <button class="btn {% if cat_status=='ë¯¸ì™„ë£Œ' %}primary{% else %}ghost{% endif %}" name="status" value="ë¯¸ì™„ë£Œ" type="submit">ë¯¸ì™„ë£Œ</button>
            <button class="btn {% if cat_status=='ì™„ë£Œ' %}primary{% else %}ghost{% endif %}" name="status" value="ì™„ë£Œ" type="submit">ì™„ë£Œ</button>
            <span class="muted">í˜„ì¬: {{ cat_status or 'ë¯¸ì…ë ¥' }}</span>
          </form>
        </div>

        <!-- ë‹´ë‹¹ì í‘œì‹œ -->
        <div>
          <b>ë‹´ë‹¹ì:</b>
          {% if owners and owners|length > 0 %}
            <ul style="margin:4px 0 0 16px; padding:0;">
              {% for o in owners %}
                <li style="list-style:disc;">
                  {{ o.name or '(ì´ë¦„ì—†ìŒ)' }}
                  <span class="muted">({{ o.email or '-' }}, {{ o.phone or '-' }})</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <span class="muted">ë“±ë¡ëœ ë‹´ë‹¹ìê°€ ì—†ìŠµë‹ˆë‹¤.</span>
          {% endif %}
        </div>
      </div>

      <hr>

      <!-- ë‹´ë‹¹ì í¸ì§‘ -->
      <form method="post" action="{{ url_for('category_owners_update') }}">
        <input type="hidden" name="ship_number" value="{{ selected_ship }}">
        <input type="hidden" name="category" value="{{ selected_category }}">
        <b>ì‹œìŠ¤í…œ ë‹´ë‹¹ì ìˆ˜ì •</b>
        <div class="inline-form" id="owners-box" style="margin-top:6px; grid-template-columns: repeat(3, minmax(180px, 1fr));">
          <div class="field">
            <label>ì´ë¦„</label>
            <input type="text" name="name1" placeholder="ì´ë¦„" value="{{ owners[0].name if owners|length>0 else '' }}">
          </div>
          <div class="field">
            <label>Email</label>
            <input type="email" name="email1" placeholder="email@example.com" value="{{ owners[0].email if owners|length>0 else '' }}">
          </div>
          <div class="field">
            <label>Phone</label>
            <input type="tel" name="phone1" placeholder="010-xxxx-xxxx" value="{{ owners[0].phone if owners|length>0 else '' }}">
          </div>

          <div class="field">
            <label>ì´ë¦„</label>
            <input type="text" name="name2" placeholder="ì´ë¦„" value="{{ owners[1].name if owners|length>1 else '' }}">
          </div>
          <div class="field">
            <label>Email</label>
            <input type="email" name="email2" placeholder="email@example.com" value="{{ owners[1].email if owners|length>1 else '' }}">
          </div>
          <div class="field">
            <label>Phone</label>
            <input type="tel" name="phone2" placeholder="010-xxxx-xxxx" value="{{ owners[1].phone if owners|length>1 else '' }}">
          </div>
        </div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
          <button type="submit" class="btn primary">ì €ì¥</button>
          <span class="muted">* ì €ì¥ ì‹œ ì—°ë½ì²˜ DBì—ë„ ë°˜ì˜ë©ë‹ˆë‹¤.</span>
        </div>
      </form>
    </div>

    <!-- ì…ë ¥ëœ í•­ëª© (ê³µìœ ) : "ì…ë ¥ëœ ê²ƒë§Œ" ë…¸ì¶œ -->
    {% set rows = [] %}
    {% for eq, info in (eqs_in_category or {}).items() %}
      {% if info is mapping %}
        {% set entered = (info.qty or info.maker or info.type or info.cert_no
                           or info.ex_proof_grade or info.ip_grade
                           or info.location or info.page
                           or info.file_key or info.file_url or info.last_modified) %}
        {% if entered %}
          {% set _ = rows.append({
            'eq': eq,
            'qty': info.qty or '',
            'maker': info.maker or '',
            'type': info.type or '',
            'cert_no': info.cert_no or '',
            'ex_proof_grade': info.ex_proof_grade or '',
            'ip_grade': info.ip_grade or '',
            'location': info.location or '',
            'page': info.page or '',
            'file_key': info.file_key or '',
            'file_url': info.file_url or '',
            'last_modified': info.last_modified or ''
          }) %}
        {% endif %}
      {% endif %}
    {% endfor %}

    {% if rows and rows|length > 0 %}
    <table class="list-compact">
      <tr>
        <th style="width:24%;">ì…ë ¥ëœ í•­ëª© (ê³µìœ )</th>
        <th>Qâ€™TY</th>
        <th>MAKER</th>
        <th>TYPE</th>
        <th>CERT.NO</th>
        <th>EX-PROOF</th>
        <th>IP</th>
        <th>LOCATION</th>
        <th>PAGE</th>
        <th>File</th>
        <th>ìˆ˜ì •ì‹œê°</th>
        <th>Action</th>
      </tr>
      {% for row in rows %}
      <tr class="done">
        <td style="text-align:left;">{{ row.eq }}</td>
        <td>{{ row.qty }}</td>
        <td>{{ row.maker }}</td>
        <td>{{ row.type }}</td>
        <td>{{ row.cert_no }}</td>
        <td>{{ row.ex_proof_grade }}</td>
        <td>{{ row.ip_grade }}</td>
        <td>{{ row.location }}</td>
        <td>{{ row.page }}</td>
        <td>
          {% if row.file_key %}
            <a href="{{ url_for('file_redirect', key=row.file_key) }}" target="_blank">ì—´ê¸°</a>
          {% elif row.file_url %}
            <a href="{{ row.file_url }}" target="_blank">ì—´ê¸°</a>
          {% else %}
            <span class="muted">-</span>
          {% endif %}
        </td>
        <td class="nowrap">{{ row.last_modified or '-' }}</td>
        <td class="nowrap">
          <a href="{{ url_for('edit', ship_number=selected_ship, category=selected_category, eq=row.eq) }}">Edit</a>
        </td>
      </tr>
      {% endfor %}
    </table>
    {% else %}
      <p class="muted">ì•„ì§ ì…ë ¥ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}

    <!-- ì‹ ê·œ ì…ë ¥ -->
    <div class="panel">
      <b>ì‹ ê·œ ì…ë ¥</b>
      <form id="newItemForm" method="post" enctype="multipart/form-data" class="inline-form"
            onsubmit="return submitNewItemToEdit();">
        <!-- ì¥ë¹„ëª…ì€ ëª©ë¡ì—ì„œ ì„ íƒ -->
        <div class="field" style="grid-column: span 2;">
          <label>Equipment Name (ëª©ë¡ì—ì„œ ì„ íƒ)</label>
          <select id="new_eq_name" required>
            <option value="">-- Select --</option>
            {% set choices = CATALOG_EQUIPMENTS.get(selected_category) or [] %}
            {% for nm in choices %}
              <option value="{{ nm }}">{{ nm }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="field">
          <label>Qâ€™TY</label>
          <input type="text" name="qty" placeholder="">
        </div>
        <div class="field">
          <label>MAKER</label>
          <input type="text" name="maker" placeholder="">
        </div>
        <div class="field">
          <label>TYPE</label>
          <input type="text" name="type" placeholder="">
        </div>
        <div class="field">
          <label>CERT.NO</label>
          <input type="text" name="cert_no" placeholder="">
        </div>
        <div class="field">
          <label>EX-PROOF GRADE</label>
          <input type="text" name="ex_proof_grade" placeholder="">
        </div>
        <div class="field">
          <label>IP GRADE</label>
          <input type="text" name="ip_grade" placeholder="">
        </div>
        <div class="field">
          <label>LOCATION</label>
          <input type="text" name="location" placeholder="">
        </div>
        <div class="field">
          <label>PAGE</label>
          <input type="text" name="page" placeholder="">
        </div>
        <div class="field" style="grid-column: span 2;">
          <label>File (ì„ íƒ)</label>
          <input type="file" name="file" accept="*/*">
        </div>

        <div class="field">
          <label>&nbsp;</label>
          <button type="submit" class="btn primary">ì €ì¥</button>
        </div>
      </form>
      <p class="muted" style="margin-top:6px;">
        * ê°’ì„ ëª°ë¼ë„ ë¹ˆì¹¸ìœ¼ë¡œ ì œì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (Edit ë¼ìš°íŠ¸ê°€ ë¹„ì›Œë‘” ê°’ë„ ì €ì¥ ì²˜ë¦¬)
      </p>
    </div>

    {% endif %}
  </div>

  <script>
    // âœ… Jinja ë¬¸ìì—´ì„ ì•ˆì „í•˜ê²Œ ì£¼ì… (tojson)
    const SELECTED_SHIP = {{ (selected_ship or "")|tojson }};
    const SELECTED_CATEGORY = {{ (selected_category or "")|tojson }};

    // ì‹ ê·œ ì…ë ¥ì„ edit POSTë¡œ ì „ë‹¬ (eq ì´ë¦„ì„ URL pathì— ë„£ì–´ì•¼ í•´ì„œ JSë¡œ action êµ¬ì„±)
    function submitNewItemToEdit(){
      var sel = document.getElementById('new_eq_name');
      if(!sel || !sel.value){
        alert('ì¥ë¹„ëª…ì„ ì„ íƒí•˜ì„¸ìš”.');
        return false;
      }
      var eq = encodeURIComponent(sel.value);
      var form = document.getElementById('newItemForm');

      // âœ… ì¹´í…Œê³ ë¦¬ì— í¬í•¨ëœ & ê°™ì€ íŠ¹ìˆ˜ë¬¸ìê°€ ì´ì¤‘ ì´ìŠ¤ì¼€ì´í”„ë˜ì§€ ì•Šë„ë¡ tojson ì£¼ì…ê°’ì„ encodeURIComponent ì²˜ë¦¬
      const ship = encodeURIComponent(SELECTED_SHIP || "");
      const cat  = encodeURIComponent(SELECTED_CATEGORY || "");

      form.action = "{{ url_for('edit', ship_number='__S__', category='__C__', eq='__E__') }}"
        .replace('__S__', ship)
        .replace('__C__', cat)
        .replace('__E__', eq);
      return true; // ì‹¤ì œ submit ì§„í–‰
    }
  </script>

</body>
</html>
