<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f6f8; }
    h2 { color: #2e7d32; margin-bottom: 8px; }
    h3 { color: #1b5e20; margin-top: 24px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; background: #fff; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #2e7d32; color: white; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    a { color: #2e7d32; text-decoration: none; font-weight: bold; }
    a:hover { text-decoration: underline; }
    button { padding: 6px 10px; background: #2e7d32; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #1b5e20; }
    .toolbar { display: flex; gap: 10px; align-items: center; margin: 8px 0 16px; }
    .split { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    .card { background:#fff; padding: 12px; border:1px solid #e0e0e0; border-radius: 8px; }
    .muted { color:#666; font-size: 12px; }
    .nowrap { white-space: nowrap; }
    .status { font-size:12px; padding-left:8px; }
    .status.ok { color:#1b5e20; }
    .status.err { color:#c62828; }
  </style>
</head>
<body>
  <h2>ğŸ“‹ Admin Dashboard</h2>

  <div class="toolbar">
    <a href="{{ url_for('export_excel') }}">ğŸ“‘ Export All</a>
    <span class="muted">ì„ íƒ í•­ëª©ë§Œ ë‚´ë³´ë‚´ë ¤ë©´ í‘œì—ì„œ ì²´í¬ í›„ ì•„ë˜ ë²„íŠ¼ ì‚¬ìš©</span>
  </div>

  <!-- Shipë³„ ìˆ˜ë™ ë©”ì¼ ì „ì†¡ -->
  <div class="card">
    <h3>ğŸš¢ Shipë³„ ìˆ˜ë™ ë©”ì¼ ì „ì†¡</h3>
    {% if ships|length == 0 %}
      <p class="muted">ë“±ë¡ëœ Shipì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% else %}
      <table>
        <tr>
          <th>Ship</th>
          <th>Due Date</th>
          <th>ë¯¸ì…ë ¥ ê±´ìˆ˜</th>
          <th style="width:50%;">ì¶”ê°€ CC (ì—°ë½ì²˜ì—ì„œ ì„ íƒ)</th>
          <th>Action</th>
        </tr>
        {% for sh in ships %}
        <tr id="row-{{ sh }}">
          <td>{{ sh }}</td>
          <td class="nowrap">{{ SHIP_DUE_DATES[sh] if SHIP_DUE_DATES and SHIP_DUE_DATES.get(sh) else '' }}</td>
          <td id="missing-{{ sh }}">{{ incomplete_count.get(sh, 0) }}</td>
          <td style="text-align:left;">
            <div style="max-height:120px; overflow:auto; border:1px solid #eee; padding:6px; border-radius:6px;">
              {% for c in contacts %}
                <label style="display:block; font-weight:normal;">
                  <input type="checkbox" name="cc-{{ sh }}" value="{{ c.email }}"> {{ c.name }} <span class="muted">({{ c.email }})</span>
                </label>
              {% endfor %}
            </div>
          </td>
          <td>
            <button type="button" onclick="sendShip('{{ sh }}')">ğŸ“§ ì „ì†¡</button>
            <span id="status-{{ sh }}" class="status"></span>
          </td>
        </tr>
        {% endfor %}
      </table>
    {% endif %}
    <p class="muted" style="margin-top:8px;">
      * ë©”ì¼ ë³¸ë¬¸ì—ëŠ” ì¹´í…Œê³ ë¦¬ë³„ ë¯¸ì…ë ¥ ì¥ë¹„ ë¦¬ìŠ¤íŠ¸ê°€ í¬í•¨ë©ë‹ˆë‹¤. (ì…ë ¥ ìš”ì²­ ë¬¸êµ¬ ìë™ í¬í•¨)
    </p>
  </div>

  <!-- ìƒì„¸ ë°ì´í„° í‘œ -->
  <form method="post" action="{{ url_for('export_selected') }}" style="margin-top:16px;">
    <table>
      <tr>
        <th><input type="checkbox" onclick="toggleAll(this)"></th>
        <th>Ship</th>
        <th>Due</th>
        <th>Category</th>
        <th>Equipment</th>
        <th>QTY</th>
        <th>Maker</th>
        <th>Type</th>
        <th>Cert No.</th>
        <th>Status</th>
        <th>Responsible</th>
        <th>Submitter</th>
        <th>File</th>
        <th class="nowrap">Action</th>
      </tr>
      {% for s in submissions %}
      <tr>
        <td>
          <input type="checkbox" name="rows[]" value="{{ s.ship_number }}|{{ s.category }}|{{ s.equipment_name }}">
        </td>
        <td>{{ s.ship_number }}</td>
        <td class="nowrap">{{ s.due_date }}</td>
        <td>{{ s.category }}</td>
        <td>{{ s.equipment_name }}</td>
        <td>{{ s.qty }}</td>
        <td>{{ s.maker }}</td>
        <td>{{ s.type }}</td>
        <td>{{ s.cert_no }}</td>
        <td>{{ s.status }}</td>
        <td>
          {% if s.responsible %}
            {{ s.responsible.name }}<br>
            <span class="muted">{{ s.responsible.email }} / {{ s.responsible.phone }}</span>
          {% endif %}
        </td>
        <td>{{ s.submitter_name }}</td>
        <td>
          {% if s.file_key %}
            <a href="{{ url_for('file_redirect', key=s.file_key) }}" target="_blank">ì—´ê¸°</a>
          {% elif s.file_url %}
            <a href="{{ s.file_url }}" target="_blank">ì—´ê¸°</a>
          {% else %}
            <span class="muted">-</span>
          {% endif %}
        </td>
        <td class="nowrap">
          <!-- Adminì—ì„œ ì§„ì… ì‹œ next=/admin ë¡œ ë˜ëŒì•„ì˜¤ê²Œ -->
          <a href="{{ url_for('edit', ship_number=s.ship_number, category=s.category, eq=s.equipment_name, next=url_for('admin_dashboard')) }}">âœï¸ Edit</a>
        </td>
      </tr>
      {% endfor %}
    </table>

    <div style="margin-top:10px;">
      <button type="submit">ğŸ“¤ ì„ íƒ í•­ëª©ë§Œ Excel Export</button>
    </div>
  </form>

  <!-- ì—°ë½ì²˜/ë¡œê·¸ íŒ¨ë„ -->
  <div class="split" style="margin-top:20px;">
    <div class="card">
      <h3>ğŸ“‡ ì—°ë½ì²˜ (AWS ì €ì¥)</h3>
      <table>
        <tr>
          <th>Name</th><th>Email</th><th>Phone</th>
        </tr>
        {% for c in contacts %}
        <tr>
          <td>{{ c.name }}</td>
          <td>{{ c.email }}</td>
          <td>{{ c.phone }}</td>
        </tr>
        {% endfor %}
      </table>
      <p class="muted">â€» í•­ëª© í¸ì§‘ ì‹œ ì±…ì„ì ë³€ê²½ ë‚´ìš©ì´ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
    </div>

    <div class="card">
      <h3>ğŸ—‚ ìµœê·¼ ë³€ê²½ ë¡œê·¸(ìƒìœ„ 50)</h3>
      <table>
        <tr>
          <th>ì‹œê°„</th><th>ì£¼ì²´</th><th>ë™ì‘</th><th>Ship</th><th>Category</th><th>EQ</th><th>ë¹„ê³ </th>
        </tr>
        {% for log in logs %}
        <tr>
          <td class="nowrap">{{ log.ts }}</td>
          <td>{{ log.actor }}</td>
          <td>{{ log.action }}</td>
          <td>{{ log.ship }}</td>
          <td>{{ log.category }}</td>
          <td>{{ log.equipment }}</td>
          <td class="muted">
            {% if log.result %}{{ log.result }}{% else %}-{% endif %}
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>
  </div>

  <script>
    function toggleAll(chk){
      const boxes = document.querySelectorAll('input[type=checkbox][name="rows[]"]');
      boxes.forEach(b=>b.checked = chk.checked);
    }

    async function sendShip(ship){
      const statusEl = document.getElementById('status-' + ship);
      statusEl.className = 'status';
      statusEl.textContent = 'ì „ì†¡ ì¤‘...';

      const ccs = [];
      document.querySelectorAll('input[name="cc-' + ship + '"]:checked').forEach(cb => ccs.push(cb.value));

      const form = new FormData();
      ccs.forEach(v => form.append('cc_emails', v));

      try {
        const res = await fetch(`{{ url_for('send_ship_mail', ship_number='__SHIP__') }}`.replace('__SHIP__', ship), {
          method: 'POST',
          headers: { 'X-Requested-With': 'fetch' },
          body: form
        });
        const data = await res.json();
        if (!res.ok || !data.ok){
          statusEl.className = 'status err';
          statusEl.textContent = data.message || 'ì „ì†¡ ì‹¤íŒ¨';
          return;
        }
        statusEl.className = 'status ok';
        statusEl.textContent = `ì „ì†¡ ì™„ë£Œ (ë¯¸ì…ë ¥ ${data.missing}ê±´, ìˆ˜ì‹ ì ${data.to.length}ëª…)`;
      } catch (e){
        statusEl.className = 'status err';
        statusEl.textContent = 'ì—ëŸ¬: ' + (e.message || e);
      }
    }
  </script>
</body>
</html>
